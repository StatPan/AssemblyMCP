name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      runner:
        description: 'Choose runner'
        default: 'self-hosted'
        type: choice
        options:
          - self-hosted
          - ubuntu-latest

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.set-runner.outputs.runner }}
    steps:
      - name: Determine runner
        id: set-runner
        run: |
          # Use input runner if available, else default to self-hosted
          SELECTED_RUNNER="${{ github.event.inputs.runner }}"
          if [ -z "$SELECTED_RUNNER" ]; then
            SELECTED_RUNNER="self-hosted"
          fi
          echo "runner=$SELECTED_RUNNER" >> $GITHUB_OUTPUT

  test:
    needs: setup
    runs-on: ${{ needs.setup.outputs.runner }}
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync --all-extras --dev

    - name: Run Linting (Ruff)
      run: uv run ruff check .

    - name: Run Formatting Check (Ruff)
      run: uv run ruff format --check .

    - name: Run Tests
      run: uv run pytest
      env:
        ASSEMBLY_API_KEY: ${{ secrets.ASSEMBLY_API_KEY }}
